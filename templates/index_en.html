<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Chatbot - FinanceBench AI Assistant</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container-fluid h-100">
        <div class="row h-100">
            <!-- Sidebar -->
            <div class="col-lg-3 col-md-4 bg-dark border-end p-0">
                <div class="d-flex flex-column h-100">
                    <div class="p-4 border-bottom">
                        <h4 class="mb-0">
                            <i class="fas fa-chart-line me-2 text-primary"></i>
                            Financial AI
                        </h4>
                        <small class="text-muted">FinanceBench Assistant</small>
                    </div>
                    
                    <div class="p-3">
                        <h6 class="text-muted mb-3">Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-secondary btn-sm quick-action" 
                                    data-message="What are Apple's most recent revenues?">
                                <i class="fas fa-dollar-sign me-2"></i>Revenue Query
                            </button>
                            <button class="btn btn-outline-secondary btn-sm quick-action" 
                                    data-message="Show me Microsoft's profit margins for the last 4 quarters">
                                <i class="fas fa-percent me-2"></i>Margin Analysis
                            </button>
                            <button class="btn btn-outline-secondary btn-sm quick-action" 
                                    data-message="Predict Tesla's revenue for the next 3 quarters">
                                <i class="fas fa-crystal-ball me-2"></i>Revenue Forecast
                            </button>
                            <button class="btn btn-outline-secondary btn-sm quick-action" 
                                    data-message="Compare Amazon and Google's earnings per share">
                                <i class="fas fa-balance-scale me-2"></i>EPS Comparison
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-3 border-top mt-auto">
                        <h6 class="text-muted mb-3">Features</h6>
                        <ul class="list-unstyled small">
                            <li class="mb-2"><i class="fas fa-database me-2 text-info"></i>FinanceBench Integration</li>
                            <li class="mb-2"><i class="fas fa-search me-2 text-success"></i>KPI Extraction</li>
                            <li class="mb-2"><i class="fas fa-brain me-2 text-warning"></i>RAG System</li>
                            <li class="mb-2"><i class="fas fa-chart-trend-up me-2 text-danger"></i>Financial Forecasting</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="col-lg-9 col-md-8 d-flex flex-column h-100">
                <!-- Chat Header -->
                <div class="border-bottom p-3 bg-dark">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-1">Financial Assistant</h5>
                            <small class="text-muted" id="connection-status">
                                <i class="fas fa-circle text-success me-1"></i>Connected
                            </small>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm" id="clear-chat">
                            <i class="fas fa-trash me-2"></i>Clear Chat
                        </button>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="flex-grow-1 p-3 overflow-auto" id="chat-messages">
                    <div class="welcome-message">
                        <div class="card bg-primary bg-opacity-10 border-primary">
                            <div class="card-body text-center">
                                <i class="fas fa-robot fa-3x text-primary mb-3"></i>
                                <h5>Welcome to the Financial AI Assistant</h5>
                                <p class="mb-0">Ask me about financial data, KPIs, forecasts or company analysis. 
                                I can help you with FinanceBench queries, extract key performance indicators, 
                                and provide financial forecasts.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="px-3" id="typing-indicator" style="display: none;">
                    <div class="d-flex align-items-center text-muted">
                        <div class="typing-animation me-2">
                            <span></span><span></span><span></span>
                        </div>
                        AI is thinking...
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="border-top p-3 bg-dark">
                    <form id="message-form" class="d-flex gap-2">
                        <div class="flex-grow-1">
                            <input type="text" 
                                   class="form-control" 
                                   id="message-input" 
                                   placeholder="Ask about financial data, KPIs or forecasts..."
                                   autocomplete="off">
                        </div>
                        <button type="submit" class="btn btn-primary" id="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div class="modal fade" id="chartModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chartModalLabel">Financial Chart</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <canvas id="financial-chart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class FinancialChatBot {
            constructor() {
                this.chartModal = new bootstrap.Modal(document.getElementById('chartModal'));
                this.currentChart = null;
                this.messageCount = 0;
                
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // Form submission
                document.getElementById('message-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendMessage();
                });

                // Quick action buttons
                document.querySelectorAll('.quick-action').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const message = e.target.getAttribute('data-message') || 
                                       e.target.closest('.quick-action').getAttribute('data-message');
                        document.getElementById('message-input').value = message;
                        this.sendMessage();
                    });
                });

                // Clear chat button
                document.getElementById('clear-chat').addEventListener('click', () => {
                    this.clearChat();
                });

                // Enter key handling
                document.getElementById('message-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
            }

            async sendMessage() {
                const messageInput = document.getElementById('message-input');
                const message = messageInput.value.trim();
                
                if (!message) return;

                // Add user message to chat
                this.addMessage(message, 'user');
                
                // Clear input
                messageInput.value = '';
                
                // Show typing indicator
                this.showTypingIndicator(true);
                
                // Disable send button
                document.getElementById('send-button').disabled = true;

                try {
                    // Send to server
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message })
                    });

                    const data = await response.json();
                    
                    if (response.ok) {
                        this.handleBotResponse(data);
                    } else {
                        this.handleError(data.message || 'Unknown error');
                    }
                } catch (error) {
                    this.handleError('Connection error: ' + error.message);
                } finally {
                    this.showTypingIndicator(false);
                    document.getElementById('send-button').disabled = false;
                }
            }

            addMessage(message, sender, data = null) {
                const chatMessages = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message mb-3`;
                
                if (sender === 'user') {
                    messageDiv.innerHTML = `
                        <div class="d-flex justify-content-end">
                            <div class="card bg-primary text-white" style="max-width: 80%;">
                                <div class="card-body p-3">
                                    <p class="mb-0">${this.escapeHtml(message)}</p>
                                    <small class="opacity-75">${new Date().toLocaleTimeString()}</small>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    const hasCharts = data && data.has_charts;
                    const chartButton = hasCharts ? 
                        `<button class="btn btn-outline-light btn-sm mt-2" onclick="chatBot.showChart(${JSON.stringify(data).replace(/"/g, '&quot;')})">
                            <i class="fas fa-chart-line me-1"></i>View Chart
                        </button>` : '';
                    
                    messageDiv.innerHTML = `
                        <div class="d-flex">
                            <div class="me-3">
                                <div class="avatar bg-success rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                    <i class="fas fa-robot text-white"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="card bg-secondary bg-opacity-20" style="max-width: 90%;">
                                    <div class="card-body p-3">
                                        <div class="message-content">${this.formatBotMessage(message, data)}</div>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <small class="text-muted">${new Date().toLocaleTimeString()}</small>
                                            ${chartButton}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Remove welcome message if exists
                const welcomeMessage = chatMessages.querySelector('.welcome-message');
                if (welcomeMessage && this.messageCount === 0) {
                    welcomeMessage.remove();
                }

                chatMessages.appendChild(messageDiv);
                this.messageCount++;
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            formatBotMessage(message, data) {
                let formattedMessage = this.escapeHtml(message);
                
                if (data) {
                    // Add KPI information
                    if (data.kpis && Object.keys(data.kpis.metrics || {}).length > 0) {
                        formattedMessage += '<div class="mt-3"><strong>Extracted KPIs:</strong><ul class="list-unstyled mt-2">';
                        for (const [metric, values] of Object.entries(data.kpis.metrics)) {
                            if (values && values.length > 0) {
                                formattedMessage += `<li><i class="fas fa-chart-bar text-info me-2"></i>${metric}: ${values[0].value}</li>`;
                            }
                        }
                        formattedMessage += '</ul></div>';
                    }

                    // Add financial data summary
                    if (data.financial_data && data.financial_data.data) {
                        const summary = data.financial_data.data.summary;
                        if (summary && summary.total_records > 0) {
                            formattedMessage += `<div class="mt-3">
                                <strong>Financial Data Summary:</strong>
                                <ul class="list-unstyled mt-2">
                                    <li><i class="fas fa-database text-primary me-2"></i>Records: ${summary.total_records}</li>
                                    <li><i class="fas fa-building text-success me-2"></i>Companies: ${summary.companies_count}</li>
                                    <li><i class="fas fa-chart-line text-warning me-2"></i>Metrics: ${summary.metrics_count}</li>
                                </ul>
                            </div>`;
                        }
                    }

                    // Add forecast information
                    if (data.forecast && data.forecast.forecast_data) {
                        const forecast = data.forecast.forecast_data;
                        formattedMessage += `<div class="mt-3">
                            <strong>Forecast Results:</strong>
                            <ul class="list-unstyled mt-2">
                                <li><i class="fas fa-crystal-ball text-info me-2"></i>Method: ${forecast.method_used || 'Linear Regression'}</li>
                                <li><i class="fas fa-calendar text-primary me-2"></i>Periods: ${data.forecast.forecast_periods}</li>
                                <li><i class="fas fa-accuracy text-success me-2"></i>MAE: ${forecast.model_performance?.mae || 'N/A'}</li>
                            </ul>
                        </div>`;
                    }
                }

                return formattedMessage;
            }

            handleBotResponse(data) {
                this.addMessage(data.message, 'bot', data);
            }

            handleError(message) {
                this.addMessage(`Error: ${message}`, 'bot');
            }

            showTypingIndicator(show) {
                const indicator = document.getElementById('typing-indicator');
                if (show) {
                    indicator.style.display = 'block';
                } else {
                    indicator.style.display = 'none';
                }
                
                // Scroll to bottom when showing/hiding typing indicator
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            clearChat() {
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.innerHTML = `
                    <div class="welcome-message">
                        <div class="card bg-primary bg-opacity-10 border-primary">
                            <div class="card-body text-center">
                                <i class="fas fa-robot fa-3x text-primary mb-3"></i>
                                <h5>Welcome to the Financial AI Assistant</h5>
                                <p class="mb-0">Ask me about financial data, KPIs, forecasts or company analysis. 
                                I can help you with FinanceBench queries, extract key performance indicators, 
                                and provide financial forecasts.</p>
                            </div>
                        </div>
                    </div>
                `;
                this.messageCount = 0;
            }

            showChart(data) {
                // Prepare chart data
                let chartData = null;
                let chartTitle = 'Financial Chart';

                if (data.financial_data && data.financial_data.data && data.financial_data.data.time_series) {
                    chartData = this.prepareFinancialChartData(data.financial_data.data);
                    chartTitle = 'Financial Data Visualization';
                } else if (data.forecast && data.forecast.forecast_data) {
                    chartData = this.prepareForecastChartData(data.forecast.forecast_data);
                    chartTitle = 'Financial Forecast';
                }

                if (!chartData) {
                    alert('No chart data available');
                    return;
                }

                // Update modal title
                document.getElementById('chartModalLabel').textContent = chartTitle;

                // Destroy existing chart
                if (this.currentChart) {
                    this.currentChart.destroy();
                }

                // Create new chart
                const ctx = document.getElementById('financial-chart').getContext('2d');
                this.currentChart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Period'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Value'
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });

                // Show modal
                this.chartModal.show();
            }

            prepareFinancialChartData(financialData) {
                const colors = ['#0d6efd', '#198754', '#dc3545', '#ffc107', '#6f42c1', '#20c997'];
                const datasets = [];
                let colorIndex = 0;

                for (const [key, series] of Object.entries(financialData.time_series)) {
                    const labels = series.data_points.map(point => point.period);
                    const data = series.data_points.map(point => point.value);

                    datasets.push({
                        label: `${series.company} - ${series.metric}`,
                        data: data,
                        borderColor: colors[colorIndex % colors.length],
                        backgroundColor: colors[colorIndex % colors.length] + '20',
                        tension: 0.3
                    });
                    colorIndex++;
                }

                // Use labels from first dataset
                const labels = Object.values(financialData.time_series)[0]?.data_points.map(point => point.period) || [];

                return {
                    labels: labels,
                    datasets: datasets
                };
            }

            prepareForecastChartData(forecastData) {
                const historicalData = forecastData.historical_values || [];
                const forecastValues = forecastData.forecast_values || [];
                const historicalDates = forecastData.historical_dates || [];
                const forecastDates = forecastData.forecast_dates || [];

                const allLabels = [...historicalDates, ...forecastDates];
                const allHistoricalData = [...historicalData, ...new Array(forecastDates.length).fill(null)];
                const allForecastData = [...new Array(historicalDates.length).fill(null), ...forecastValues];

                return {
                    labels: allLabels,
                    datasets: [
                        {
                            label: 'Historical Data',
                            data: allHistoricalData,
                            borderColor: '#0d6efd',
                            backgroundColor: '#0d6efd20',
                            tension: 0.3
                        },
                        {
                            label: 'Forecast',
                            data: allForecastData,
                            borderColor: '#dc3545',
                            backgroundColor: '#dc354520',
                            borderDash: [5, 5],
                            tension: 0.3
                        }
                    ]
                };
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize chatbot when page loads
        const chatBot = new FinancialChatBot();
    </script>
</body>
</html>